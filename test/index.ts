import test from 'ava'
import * as fs from "fs"
import {BlockchainInfo, RPC} from '../src/proxy'
import {Transaction} from 'bitcoinjs-lib'

test('blockchain.info proxy', async t => {
  let txHash = "f3a935718cf0c7da38b53bbed75968df68b68cfbf28abec423f716adf970dfae"
  let tx = Transaction.fromHex("0100000001dfc343ea882f3145458d9e9cf15a92378efb464d12959144b6805c6b5a06e539010000006b483045022100d6c719fe26acc319055328aead1225073af55f5ec9481d3c7873bb07d512cb61022006674ee9e28eaccb5164fcab62e5ba22d01bb7ff5f8ea1dbbb7327c35f490f5b012102048a86962d920ebac4565c4fab7748c9361da8ea79d9b8b7c635f42bc26f8fceffffffff0280a90300000000001976a91415177e6a56668efe4598657cf1462ebda786a36888acb0e6d416000000001976a914b400b6356d0c7a0397735ee3313afa561bfa3d8f88ac00000000")
  let coinbaseTX = Transaction.fromHex("010000000101820e2169131a77976cf204ce28685e49a6d2278861c33b6241ba3ae3e0a49f020000008b48304502210098a2851420e4daba656fd79cb60cb565bd7218b6b117fda9a512ffbf17f8f178022005c61f31fef3ce3f906eb672e05b65f506045a65a80431b5eaf28e0999266993014104f0f86fa57c424deb160d0fc7693f13fce5ed6542c29483c51953e4fa87ebf247487ed79b1ddcf3de66b182217fcaf3fcef3fcb44737eb93b1fcb8927ebecea26ffffffff02805cd705000000001976a91429d6a3540acfa0a950bef2bfdc75cd51c24390fd88ac80841e00000000001976a91417b5038a413f5c5ee288caa64cfab35a0c01914e88ac00000000")
  let p = new BlockchainInfo()
  let prevHash: Buffer = await p.getPrevHash(tx)
  t.truthy(prevHash)
})

test.only("bitcoin core rpc client", async t =>{
  let testConfPath: fs.PathLike = "/Users/miyamotojou/working/blockchain/BTC/bitcoin/lightning-sandbox.conf"
  let p = new RPC(testConfPath)
  let tx = Transaction.fromHex("02000000031535b58ac5c7bacf015a3321a6854f952caa7fd58a291c0f5c4cbf2caaa71105000000006a473044022047360039d6e5e23def88c64f5307b75353f1199aba09589e38fd4437d8e3a7f3022039c1416fcca3f4c2870400746683cb19915b8e77a290f236ae4b853e4f2e492e012103341119e4197f418b7e7222c189d67acd9d8da9a20d6ab79e44f6d4b30b5d9041feffffff7131727b840979de664b4f8975af374c9ba8b4f578da5619db785693a28ea1a9130000006b483045022100ed5fb921c194a654e2bdf535ca1676d808e4ac80a89ced772cfbef47ee065f3902200774ea1ebf6d959c93c2ca589245cf11288b803a203e812d7738299b0bf9939e01210385f5818a0e8817f5b1523399730c9fd42a525af65f7cde17a339e2f1710b463bfeffffffeb3bb6128ec93f130789ad63a920935e8a503a2b156b01ee185a2dfe3e9d3c0c020000006b483045022100f5657d4e1cbac39371df34b3d9e067eadc3a5718f410177a78d1e23f82381f6702202e103426c82df5ff9200e9daec737c88d195afe85c44efb8e0b849e45c011d90012103503362b6f057c37d9f226bfd91b7a51aa367ded31737c8d0d6223f10bd3f7c77feffffff0360a62f010000000017a91460b823ef8a7c4ebf052c78578d15c871ee099c7e87459a0b00000000001976a91487e00567c6f1c74b9ecd7d5d985795c4eb6c5b9388acef241d000000000017a914a58afb31b124c1715f1fe343ca02b2d5ee82080487a1c30700")
  p.getPrevHash(tx)
})